# -*- coding: utf-8 -*-
import os
import pyodbc
import traceback

# -------------------------------
# CONFIGURACI√ìN
# -------------------------------
# Carpeta con las im√°genes (80 archivos)
CARPETA_IMAGENES = u"C:\\Users\\piava\\Pictures\\simbolos_convertidos"

# Archivo .style en el que se insertar√°n los s√≠mbolos
ARCHIVO_STYLE = u"C:\\Users\\piava\\Documents\\ArcGIS\\SIMBOLOGIA\\Plantilla_copy.style"

# Archivo con el objeto base extra√≠do de un s√≠mbolo v√°lido
RUTA_OBJECT_BASE = u"C:\\Users\\piava\\Documents\\estructura_symbol_valido.bin"

# Offset donde se inyecta la imagen en object_base (ajusta si es necesario)
OFFSET = 200

# -------------------------------
# FUNCIONES AUXILIARES
# -------------------------------
def convertir_a_unicode(texto):
    """Convierte texto a Unicode en Python 2.7."""
    if isinstance(texto, unicode):
        return texto
    try:
        return unicode(texto, "utf-8")
    except UnicodeDecodeError:
        try:
            return unicode(texto, "latin-1")
        except UnicodeDecodeError:
            return unicode(texto, "ascii", "ignore")

def conectar_db(archivo_style):
    """Conecta a la base de datos y retorna (conn, cursor)."""
    conn_str = u"DRIVER={Microsoft Access Driver (*.mdb, *.accdb)};DBQ=" + archivo_style
    conn = pyodbc.connect(conn_str)
    cursor = conn.cursor()
    return conn, cursor

# -------------------------------
# L√ìGICA PRINCIPAL
# -------------------------------
def main():
    print u"üîµ INICIO DEL SCRIPT: Inyectar im√°genes en la plantilla"
    
    # Leer el object_base previamente extra√≠do
    try:
        with open(RUTA_OBJECT_BASE, "rb") as f:
            object_base = f.read()
        print u"‚úÖ object_base le√≠do, tama√±o: %d bytes" % len(object_base)
    except Exception as e:
        print u"‚ùå Error al leer object_base:", e
        return

    # Conectar a la base de datos
    try:
        conn, cursor = conectar_db(ARCHIVO_STYLE)
        print u"‚úÖ Conexi√≥n a la base de datos exitosa"
    except Exception as e:
        print u"‚ùå Error de conexi√≥n:", e
        return

    # Verificar que la carpeta de im√°genes exista
    if not os.path.exists(CARPETA_IMAGENES):
        print u"‚ùå Error: La carpeta de im√°genes no existe:", CARPETA_IMAGENES
        conn.close()
        return

    # Obtener la lista de im√°genes en la carpeta (formatos v√°lidos)
    imagenes = [f for f in os.listdir(CARPETA_IMAGENES) if f.lower().endswith((".bmp",".png",".jpg",".jpeg",".gif",".tif",".tiff"))]
    if not imagenes:
        print u"‚ö†Ô∏è No se encontraron im√°genes en la carpeta:", CARPETA_IMAGENES
    else:
        print u"‚úÖ Se encontraron %d im√°genes." % len(imagenes)
        for imagen in imagenes:
            nombre_simbolo = os.path.splitext(imagen)[0].strip()
            nombre_simbolo_unicode = convertir_a_unicode(nombre_simbolo)
            ruta_imagen = os.path.join(CARPETA_IMAGENES, imagen)
            print u"üîπ Procesando s√≠mbolo: %s" % nombre_simbolo_unicode

            try:
                # Leer la imagen en binario
                with open(ruta_imagen, "rb") as f_img:
                    imagen_binaria = f_img.read()

                # Calcular el m√°ximo permitido para la imagen (para no sobrepasar el tama√±o de object_base)
                max_imagen = len(object_base) - OFFSET
                if len(imagen_binaria) > max_imagen:
                    print u"‚ö†Ô∏è La imagen '%s' es demasiado grande, se recortar√°." % nombre_simbolo_unicode
                    imagen_binaria = imagen_binaria[:max_imagen]

                # Crear object_final inyectando la imagen en object_base sin alterar su estructura
                object_final = object_base[:OFFSET] + imagen_binaria + object_base[OFFSET + len(imagen_binaria):]

                # Verificar si el s√≠mbolo ya existe
                cursor.execute(u"SELECT COUNT(*) FROM [Marker Symbols] WHERE Name=?", (nombre_simbolo_unicode,))
                existe = cursor.fetchone()[0]

                if existe == 0:
                    # Insertar nuevo s√≠mbolo
                    sql_insert = u"INSERT INTO [Marker Symbols] (Name, Category, Type, Object, Tags) VALUES (?, ?, ?, ?, ?)"
                    cursor.execute(sql_insert, (nombre_simbolo_unicode, u"S√≠mbolos de Marcador", u"Picture Marker Symbol", pyodbc.Binary(object_final), u"Autom√°tico"))
                    print u"‚úÖ S√≠mbolo insertado:", nombre_simbolo_unicode
                else:
                    # Sobrescribir el s√≠mbolo existente
                    sql_update = u"UPDATE [Marker Symbols] SET Category=?, Type=?, Object=?, Tags=? WHERE Name=?"
                    cursor.execute(sql_update, (u"S√≠mbolos de Marcador", u"Picture Marker Symbol", pyodbc.Binary(object_final), u"Autom√°tico", nombre_simbolo_unicode))
                    print u"‚ôªÔ∏è S√≠mbolo sobrescrito:", nombre_simbolo_unicode

            except Exception as e:
                print u"‚ùå Error al procesar '%s': %s" % (nombre_simbolo_unicode, e)
                traceback.print_exc()

    # Guardar cambios y cerrar la conexi√≥n
    conn.commit()
    cursor.close()
    conn.close()
    print u"üéØ Archivo .style actualizado en:", ARCHIVO_STYLE
    print u"‚úÖ SCRIPT FINALIZADO"

if __name__ == "__main__":
    try:
        main()
    except Exception as ex:
        print u"‚ùå ERROR FATAL:", ex
        traceback.print_exc()
